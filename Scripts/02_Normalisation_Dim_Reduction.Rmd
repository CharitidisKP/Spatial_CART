---
title: "Normalisation, Scaling and Dimentionality reduction"
author: "Konstantinos Charitidis"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float:
      collapse: false
    number_sections: true
    df_print: paged
    theme: readable
    code_folding: hide
    self_contained: true
    highlight: tango
---

```{r Setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
options(max.print = 200)

```

```{r Libraries, include = FALSE}

library(tidyverse)
library(Seurat)
library(SeuratObject)
library(Matrix)
source(file = "~/P_lab/Spatial_CART/Scripts/Other/My_Functions.R")
Init_project("~/P_lab/Spatial_CART/")

```

```{r Load the filtered seurat object}

set.seed(1511)

## Load the merged and filtered seurat object ##
## Currently this doesn't exist ##
Seurat_filtered <- readRDS(file = file.path(main_dir, "Data", "Edited_data", "Seurat_filtered_step_4.Rds"))

```

```{r Normalise and scale the seurat object counts}

Seurat_norm <- NormalizeData(Seurat_filtered, normalization.method = "LogNormalize",
                                scale.factor = 1e4)

Seurat_norm <- FindVariableFeatures(Seurat_norm, selection.method = "vst", nfeatures = 3000)

Seurat_norm <- ScaleData(Seurat_norm, features = VariableFeatures(Seurat_norm))

```

```{r PCA prep}

Seurat_norm <- RunPCA(Seurat_norm, features = VariableFeatures(object = Seurat_norm), npcs = 50)

ElbowPlot(Seurat_norm, ndims = 50, reduction = "pca")

DimPlot(Seurat_norm, reduction = "pca") + 
  NoLegend()

VizDimLoadings(Seurat_norm, dims = 1:2, reduction = "pca")

## Retrieve standard deviations from the PCA ##
stdev <- Seurat_norm[["pca"]]@stdev

## Convert to variance explained per PC ##
var_explained <- stdev^2 / sum(stdev^2)

## Cumulative variance explained ##
cum_var <- cumsum(var_explained)

## Pick the number of PCs required to explain 50% of the variance ##
## Change this number depending on the downstream analysis ##
num_pcs <- which(cum_var >= 0.60)[1]

## Combine the minimum cumulative variance with the elbow plot ##
elbow_num <- which(diff(stdev) > -0.1)[1]
n_pcs_use <- min(num_pcs, elbow_num)

## Print the selected number ##
cat("Using", n_pcs_use, "PCs (", round(cum_var[n_pcs_use] * 100, 1), "% variance)\n")

```

```{r Neighbors and clusters}

Seurat_norm <- FindNeighbors(Seurat_norm, dims = 1:num_pcs)

Seurat_norm <- FindClusters(Seurat_norm, 
                              resolution = c(0.25, 0.5, 0.75, 1.0))

Idents(Seurat_norm) <- "RNA_snn_res.0.5"

```

```{r UMAP prep}

Seurat_norm <- RunUMAP(Seurat_norm, dims = 1:num_pcs)

DimPlot(Seurat_norm, reduction = "umap", group.by = "fov")

```


```{r Save the normalised seurat object with PCAs and UMAPs}

SaveSeuratRds(object = Seurat_norm, file = file.path(main_dir, "Data", "Edited_data", "Seurat_normalised.Rds"))

```
