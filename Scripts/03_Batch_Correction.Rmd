---
title: "Batch correction of Crosslee's Seurat objects"
author: "Konstantinos Charitidis"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float:
      collapse: false
    number_sections: true
    df_print: paged
    theme: readable
    code_folding: hide
    self_contained: true
    highlight: tango
---

```{r setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
options(max.print = 200)

```

```{r Libraries, include = FALSE}

library(tidyverse)
library(Seurat)
library(SeuratObject)
library(Matrix)
library(harmony)

```

```{r Load the filtered seurat object}

qc_dir <- "~/P_lab/Spatial_CART/"

## Change this one you have finalised a merged object ##
Seurat_obj <- readRDS(file = paste0(qc_dir, "Data/Edited_data/Seurat_Slides_12_Crosslee.Rds"))

Seurat_obj@meta.data <- Seurat_obj@meta.data %>% 
  mutate(Slide_num = str_extract(Run_Tissue_name, "(?<=Slide)\\d+"), 
         ## Contained here i didn't have to use the regex ##
         # Slide = paste0("Slide_", slide_ID_numeric),
         Slide = paste0("Slide_", Slide_num))

```

```{r}

Umap_pre_harmony <- DimPlot(Seurat_obj, reduction = "umap", group.by = "Slide") +
  labs(title = NULL) +                     
  plot_annotation(title = "UMAP before batch correction by slide") +
  theme(legend.title = element_blank())

PCA_pre_harmony <- DimPlot(Seurat_obj, reduction = "pca", group.by = "Slide") +
  labs(title = NULL) +                     
  plot_annotation(title = "PCA before batch correction by slide") +
  theme(legend.title = element_blank())

Vln_pre_harmony <- VlnPlot(Seurat_obj, features = c("nFeature_RNA", "nCount_RNA"), group.by = "Slide", pt.size = 0) +
  # labs(title = NULL) +                     
  plot_annotation(title = "Vln plot before batch correction by slide") +
  theme(legend.title = element_blank())

Umap_pre_harmony_cell_types <- DimPlot(Seurat_obj, reduction = "umap", group.by = "RNA_Export_Cell.Typing.InSituType.1_1_clusters", label = TRUE) +
  labs(title = NULL) +                     
  plot_annotation(title = "UMAP before batch correction by celltype") +
  theme(legend.title = element_blank())

# Seurat_obj %>% 
#   SplitObject(split.by = "Slide") %>%
#   lapply(function(obj) {
#     rowMeans(GetAssayData(obj, slot = "counts") > 0)
#   })

Umap_pre_harmony
PCA_pre_harmony
Vln_pre_harmony

# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_pre_Batch/UMAP_pre_batch_per_slide.png"),
#        plot = Umap_pre_harmony, width = 6, height = 4, dpi = 300)
# 
# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_pre_Batch/PCA_pre_batch_per_slide.png"),
#        plot = PCA_pre_harmony, width = 6, height = 4, dpi = 300)
# 
# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_pre_Batch/Vln_pre_batch_per_slide.png"),
#        plot = Vln_pre_harmony, width = 12, height = 10, dpi = 300)
# 
# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_pre_Batch/UMAP_pre_batch_per_celltype.png"),
#        plot = Umap_pre_harmony_cell_types, width = 16, height = 8, dpi = 300)

```

```{r QC to see if batch effect exists}

tab_pre_harmony <- table(Seurat_obj$seurat_clusters, Seurat_obj$Slide)

prop_tab_pre_harmony <- prop.table(tab_pre_harmony, margin = 1)
round(prop_tab_pre_harmony, 2)

df_pre_harmony <- as.data.frame(tab_pre_harmony)
colnames(df_pre_harmony) <- c("Cluster", "Slide", "Freq")

ggplot(df_pre_harmony, aes(x = Cluster, y = Freq, fill = Slide)) +
  geom_bar(stat = "identity", position = "fill") +
  ylab("Proportion within cluster") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

emb_pre_harmony <- Embeddings(Seurat_obj, reduction = "pca")

# function to get R² of Slide for each dimension
get_r2 <- function(x, batch) {
  summary(lm(x ~ batch))$adj.r.squared
}

n_dims <- min(10, ncol(emb_pre_harmony))

r2s_pre_harmony <- apply(emb_pre_harmony[, seq_len(n_dims), drop = FALSE], 
                         2, get_r2, batch = factor(Seurat_obj$Slide)) 

r2s_pre_harmony_df <- r2s_pre_harmony %>% 
  tibble(PC = factor(names(r2s_pre_harmony), levels = names(r2s_pre_harmony)), 
         R2 = as.numeric(r2s_pre_harmony)) %>% 
  select(PC, R2)

R2s_barplot_pre_batch <- ggplot(r2s_pre_harmony_df, aes(x = PC, y = R2)) + 
  geom_col() +
  labs(title = expression(R^2 ~ "of slide per PC before batch correction"), 
       x = "Principal component", y = expression("Adjusted" ~ R^2)) +
  theme_bw() 

# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_pre_Batch/R2s_barplot_pre_batch.png"),
#        plot = R2s_barplot_pre_batch, width = 16, height = 8, dpi = 300)

```

```{r}

Seurat_obj <- RunHarmony(Seurat_obj, group.by.vars = "Slide")

Seurat_obj <- RunUMAP(Seurat_obj, reduction = "harmony", dims = 1:30)
Seurat_obj <- FindNeighbors(Seurat_obj, reduction = "harmony", dims = 1:30)
Seurat_obj <- FindClusters(Seurat_obj, resolution = c(0.25, 0.5, 0.75, 1.0))

Umap_post_harmony_per_slide <- DimPlot(Seurat_obj, reduction = "umap", group.by = "Slide") +
  labs(title = NULL) +                     
  plot_annotation(title = "UMAP after batch correction by slide") +
  theme(legend.title = element_blank())
  
Umap_post_harmony_per_cluster <- DimPlot(Seurat_obj, group.by = "seurat_clusters") +
  labs(title = NULL) +                     
  plot_annotation(title = "UMAP after batch correction by cluster") +
  theme(legend.title = element_blank())

Umap_post_harmony_per_slide
Umap_post_harmony_per_cluster

# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_pre_Batch/UMAP_post_batch_per_slide.png"),
#        plot = Umap_post_harmony_per_slide, width = 6, height = 4, dpi = 300)
# 
# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_pre_Batch/UMAP_post_batch_per_cluster.png"),
#        plot = Umap_post_harmony_per_cluster, width = 6, height = 4, dpi = 300)

```

```{r QC to see if batch effect was removed}

tab_post_harmony <- table(Seurat_obj$seurat_clusters, Seurat_obj$Slide)

prop_tab_post_harmony <- prop.table(tab_post_harmony, margin = 1)
round(prop_tab_post_harmony, 2)

df_post_harmony <- as.data.frame(tab_post_harmony)
colnames(df_post_harmony) <- c("Cluster", "Slide", "Freq")

ggplot(df_post_harmony, aes(x = Cluster, y = Freq, fill = Slide)) +
  geom_bar(stat = "identity", position = "fill") +
  ylab("Proportion within cluster") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

emb_post_harmony <- Embeddings(Seurat_obj, "harmony")
slide_post_harmony <- factor(Seurat_obj$Slide)

# function to get R² of Slide for each dimension
get_r2 <- function(x, batch) {
  summary(lm(x ~ batch))$adj.r.squared
}

n_dims <- min(10, ncol(emb_post_harmony))

r2s_post_harmony <- apply(emb_post_harmony[, seq_len(n_dims), drop = FALSE], 
                          2, get_r2, batch = factor(Seurat_obj$Slide)) 

r2s_post_harmony_df <- r2s_post_harmony %>% 
  tibble(PC = factor(names(r2s_post_harmony), levels = names(r2s_post_harmony)), 
         R2 = as.numeric(r2s_post_harmony)) %>% 
  select(PC, R2)

R2s_barplot_post_batch <- ggplot(r2s_post_harmony_df, aes(x = PC, y = R2)) + 
  geom_col() +
  labs(title = expression(R^2 ~ "of slide per PC after batch correction"), 
       x = "Principal component", y = expression("Adjusted" ~ R^2)) +
  theme_bw() 

Umap_celltypes_post_har <- DimPlot(Seurat_obj, reduction = "umap", 
                                   group.by = "RNA_Export_Cell.Typing.InSituType.1_1_clusters")

# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_post_Batch/R2s_barplot_post_batch.png"),
#        plot = R2s_barplot_post_batch, width = 16, height = 8, dpi = 300)
# 
# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_post_Batch/Umap_celltypes_post_harmony.png"),
#        plot = Umap_celltypes_post_har, width = 12, height = 8, dpi = 300)

```
 
```{r Separate the objects}

# Seurat_obj_CART <- subset(Seurat_obj, subset = Run_Tissue_name == "MCF-ASCIST-1250-Slide1 (1979 8769 6063 4322)")
# Seurat_obj_CTRL <- subset(Seurat_obj, subset = Run_Tissue_name == "MCF-ASCIST-1250-Slide2 (1281)")

```

```{r See the differences}

# DimPlot(Seurat_obj_CART, reduction = "umap", group.by = "Run_Tissue_name")
# DimPlot(Seurat_obj_CTRL, reduction = "umap", group.by = "Run_Tissue_name")

```


```{r Get the cell proportions per cluster}

tab_celltypes <- table(Seurat_obj$seurat_clusters, Seurat_obj$RNA_Export_Cell.Typing.InSituType.1_1_clusters)
tab_celltypes

prop_celltypes <- prop.table(tab_celltypes, margin = 1)  # proportions within cluster

df_celltype_fqs <- prop_celltypes %>% 
  as.data.frame() %>% 
  mutate(Freq = round(Freq, 3)) %>% 
  dplyr::rename(Cluster = "Var1", Celltype = "Var2") 
# %>% 
  # pivot_wider(id_cols = "Cluster", names_from = "Celltype", values_from = "Freq")

Celltype_fqs_post_batch <- ggplot(df_celltype_fqs, aes(x = Cluster, y = Freq, fill = Celltype)) +
  geom_bar(stat = "identity", position = "fill") +
  ylab("Proportion within cluster") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

tab_slide_major <- table(Seurat_obj$RNA_Export_Cell.Typing.InSituType.1_1_clusters, Seurat_obj$Slide)
round(prop.table(tab_slide_major, margin = 1), 2)

# ggsave(filename = file.path(qc_dir, "Results/After_Normalisation_post_Batch/Celltype_fqs_post_batch.png"),
#        plot = Celltype_fqs_post_batch, width = 16, height = 8, dpi = 300)

SaveSeuratRds(object = Seurat_obj, file = "../Data/Edited_data/Seurat_obj_after_batch.Rds")

```

```{r Reload the batch corrected object}

qc_dir <- "~/P_lab/Spatial_CART/"
Seurat_obj <- readRDS(file = paste0(qc_dir, "Data/Edited_data/Seurat_obj_after_batch.Rds"))

```

```{r Slide intergrated marker sets}

# Idents_old <- Idents(Seurat_obj)
Idents(Seurat_obj) <- "RNA_Export_Cell.Typing.InSituType.1_1_clusters"

markers_major <- FindAllMarkers(Seurat_obj,
                                only.pos = TRUE,
                                logfc.threshold = 0.25,
                                min.pct = 0.1,
                                test.use = "wilcox")

top20_major <- markers_major %>% 
  group_by(cluster) %>% 
  top_n(20, wt = avg_log2FC)

# write_csv(x = top20_major, file = paste0(qc_dir, "Results/Tables/Top_20_Markers_after_batch_per_cluster.csv"))
# write_csv(x = markers_major, file = paste0(qc_dir, "Results/Tables/FindAllMarkers_after_batch_per_cluster.csv"))

```
