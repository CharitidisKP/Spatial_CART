---
title: "Annotation of the batch corrected seurat object"
author: "Konstantinos Charitidis"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float:
      collapse: false
    number_sections: true
    df_print: paged
    theme: readable
    code_folding: hide
    self_contained: true
    highlight: tango
---

```{r Setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
options(max.print = 200)

```

```{r Libraries, include = FALSE}

library(tidyverse)
library(Seurat)
library(SeuratObject)
library(Matrix)
library(InSituType)
source(file = "~/P_lab/Spatial_CART/Scripts/Other/My_Functions.R")
Init_project("~/P_lab/Spatial_CART/")

```

```{r Load the batch corrected seurat oject}

Seurat_obj <- readRDS(file = file.path(main_dir, "Data", "Edited_data", "Seurat_batch_corrected.Rds"))

```

```{r Load the reference from nanostring - 6K panel KidneyRCC}

## Load the reference matrix from github ##
Ref_mat <- read.csv("https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Cell-Profiles/main/Human/KidneyRCC_6k/KidneyRCC_6k.profiles.csv", 
                    row.names = 1, header = TRUE)

Counts <- GetAssayData(Seurat_obj, assay = "RNA", layer = "counts")
Neg_probs <- GetAssayData(Seurat_obj, assay = "negprobes", layer = "counts")

## Get the common cells between our seurat object counts and the reference ##
My_genes <- Counts %>% 
  rownames()

Ref_genes <- rownames(Ref_mat)

Common_genes <- intersect(x = My_genes, y = Ref_genes)
Common_genes <- sort(Common_genes)

## Filter the reference based on the common panel ##
Counts_sub <- Counts[Common_genes, ]
Ref_mat_sub <- Ref_mat[Common_genes, ]

## Make sure counts are in the correct format ##
# Counts_sub <- as(Counts_sub, "dgCMatrix")

## Build a per cell negative vector ##
Cell_IDs <- colnames(Counts_sub)

Counts_sub <- Matrix::t(Counts_sub)
Neg_probs <- Matrix::t(Neg_probs)

stopifnot(identical(rownames(Counts_sub), rownames(Neg_probs)))

## Visualise for sanity ##
pheatmap::pheatmap(sweep(Ref_mat_sub, 1, pmax(apply(Ref_mat_sub, 1, max), 0.2), "/"), 
                   col = colorRampPalette(c("white", "darkblue"))(100))

```

```{r}

insitutypefileloc <- file.path(main_dir, "/Data/Edited_data/Annotation_6k_Kidney_RCC.Rds")
if (!file.exists(insitutypefileloc)) {

  set.seed(1511)
  res <- InSituType::insitutype(x = Counts_sub,
                                neg = Matrix::rowMeans(Neg_probs),
                                reference_profiles = Ref_mat_sub,
                                update_reference_profiles = FALSE,
                                n_clust = 6)

  saveRDS(res, file = insitutypefileloc)

} else {
  res <- readRDS(insitutypefileloc)
}

```

```{r Create the sample id column}

Sample_meta <- Seurat_obj@meta.data %>% 
  mutate(Slide_num = as.integer(Slide_num), 
  Sample = case_when(Slide_num == 1 & fov >=  1 & fov <= 28 ~ 4,
                     Slide_num == 1 & fov >= 29 & fov <= 41 ~ 3,
                     Slide_num == 1 & fov >= 42 & fov <= 54 ~ 2,
                     Slide_num == 1 & fov >= 55 & fov <= 71 ~ 1,
                     Slide_num == 2 ~ 5, TRUE ~ NA)) 

Seurat_obj@meta.data <- Sample_meta

```

```{r Lets get a look at the FOVs before the anotation}

  Seurat_obj@meta.data %>%
  select(fov, x_FOV_px, y_FOV_px, x_slide_mm, y_slide_mm, Slide_num) %>% 
  transform(., x_px = x_slide_mm * 0.18,
            y_px = y_slide_mm * 0.18) %>% 
  ggplot(., aes(x = x_px, y = y_px)) +
  geom_point(size = 0.1, alpha = 0.6) +
  coord_equal() +
  facet_wrap(~ Slide_num) +
  theme_void() +
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  labs(colour = "FOV", title = "Cells coloured by FOV")

```

```{r Load CSVs with the markers}

Markers <- read_csv(file = paste0(main_dir, "Results/Tables/FindAllMarkers_after_batch_per_cluster.csv"))

```

```{r Load the annotation data}

## Alternative if you have multiple annotation files from InSituType is a for loop ##
Annotation_6k_KRCC <- readRDS(file.path(main_dir, "/Data/Annotations/Annotation_6k_Kidney_RCC.Rds"))

```

```{r Flightpath using the annotation list}

Flightpath_6k_KRCC <- InSituType::flightpath_layout(logliks = Annotation_6k_KRCC$logliks, 
                                                    profiles = Annotation_6k_KRCC$profiles)

```

```{r Visualise the annotation and save the figure}

Flightpath_6k_KRCC_plot <- plot_flightpath_leg(Flightpath_6k_KRCC)

ggsave(plot = Flightpath_6k_KRCC_plot, filename = file.path(main_dir, "Results/After_Annotation/Flightpath_6k_KRCC.png"), 
       width = 12, height = 8, dpi = 300)

```