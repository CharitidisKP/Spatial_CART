---
title: "Annotation of the batch corrected seurat object"
author: "Konstantinos Charitidis"
date: "`r format(Sys.time(), '%Y-%m-%d')`"
output:
  html_document:
    toc: true
    toc_depth: '3'
    df_print: paged
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    toc_float:
      collapse: false
    number_sections: true
    df_print: paged
    theme: readable
    code_folding: hide
    self_contained: true
    highlight: tango
---

```{r Setup, include = FALSE}

knitr::opts_chunk$set(echo = TRUE, eval = TRUE, message = FALSE, warning = FALSE)
options(max.print = 200)

```

```{r Libraries, include = FALSE}

library(tidyverse)
library(Seurat)
library(SeuratObject)
library(Matrix)
library(InSituType)

```

```{r Load the batch corrected seurat oject}

main_dir <- "~/P_lab/Spatial_CART/"
Seurat_obj <- readRDS(file = paste0(main_dir, "Data/Edited_data/Seurat_obj_after_batch.Rds"))

```

```{r Load CSVs with the markers}

Markers <- read_csv(file = paste0(main_dir, "Results/Tables/FindAllMarkers_after_batch_per_cluster.csv"))

```

```{r Provide the preexisting annotations as identities}

Idents(Seurat_obj) <- "RNA_Export_Cell.Typing.InSituType.1_1_clusters"

```

```{r Create the sample id column}

Sample_meta <- Seurat_obj@meta.data %>% 
  mutate(Slide_num = as.integer(Slide_num), 
  Sample = case_when(Slide_num == 1 & fov >=  1 & fov <= 28 ~ 4,
                     Slide_num == 1 & fov >= 29 & fov <= 41 ~ 3,
                     Slide_num == 1 & fov >= 42 & fov <= 54 ~ 2,
                     Slide_num == 1 & fov >= 55 & fov <= 71 ~ 1,
                     Slide_num == 2 ~ 5, TRUE ~ NA)) 

Seurat_obj@meta.data <- Sample_meta

```

```{r Lets get a look at the FOVs before the anotation}

  Seurat_obj@meta.data %>%
  select(fov, x_FOV_px, y_FOV_px, x_slide_mm, y_slide_mm) %>% 
  transform(., x_px = x_slide_mm * 0.18,
            y_px = y_slide_mm * 0.18) %>% 
  ggplot(., aes(x = x_px, y = y_px, colour = factor(fov))) +
  geom_point(size = 0.1, alpha = 0.6) +
  coord_equal() +
  theme_void() +
  guides(colour = guide_legend(override.aes = list(size = 2))) +
  labs(colour = "FOV", title = "Cells coloured by FOV")

```

```{r Load the reference from nanostring - 6K panel KidneyRCC}

## Load the reference matrix from github ##
Ref_mat <- read.csv("https://raw.githubusercontent.com/Nanostring-Biostats/CosMx-Cell-Profiles/main/Human/KidneyRCC_6k/KidneyRCC_6k.profiles.csv", 
                    row.names = 1, header = TRUE)

## Get the common cells between our seurat object counts and the reference ##
Ref_genes <- rownames(Ref_mat)

My_genes <- GetAssayData(Seurat_obj, layer = "counts") %>% 
  rownames()

Common_genes <- intersect(x = My_genes, y = Ref_genes)

## Filter the reference based on the common panel ##
Ref_mat_2 <- Ref_mat[is.element(rownames(Ref_mat), Common_genes), ]

## Visualise for sanity ##
pheatmap::pheatmap(sweep(Ref_mat_2, 1, pmax(apply(Ref_mat_2, 1, max), 0.2), "/"), 
                   col = colorRampPalette(c("white", "darkblue"))(100))

```

```{r}

InSituType::insitutype(x = )
GetAssayData(assay = "RNA", layer = "counts")




```

